# 基于 STM32F103 的十字路口交通灯控制系统

## 项目概述

本项目是一个嵌入式系统开发实训项目，基于 **STM32F103R6**（STM32F10x 系列）微控制器，实现一个完整的十字路口交通灯控制系统。系统支持 **四种运行模式**，具备红绿黄灯控制、双向倒计时数码管显示、黄灯闪烁、按键模式切换等功能。

项目采用 **纯寄存器编程**（不依赖标准库 HAL/LL），代码结构清晰、模块化，便于学习 STM32 底层寄存器操作。仿真环境为 **Proteus 8.17**，实际硬件也可直接移植。

**当前版本**：v1.0  
**作者**：JaRyon  
**日期**：2025-12

## 系统功能

### 1. 四种运行模式（通过 4 个按键切换）
| 按键 | 模式                  | 功能描述                                                                 |
|------|-----------------------|--------------------------------------------------------------------------|
| KEY1 | 正常模式（默认）      | 南北绿 → 南北黄 → 东西绿 → 东西黄 → 循环，带倒计时显示                     |
| KEY2 | 全红模式              | 东西南北全部红灯，常用于紧急情况或禁止通行                                 |
| KEY3 | 夜间黄闪模式          | 四向黄灯每 0.5 秒闪烁一次，数码管熄灭，适用于夜间低流量时段               |
| KEY4 | 单向禁止通行模式      | 每次按下切换：南北红 + 东西绿（持续） ↔ 东西红 + 南北绿（持续），数码管熄灭 |

### 2. 倒计时显示
- 使用 4 位共阳数码管动态扫描显示
- 东西向倒计时（左两位）与南北向倒计时（右两位）同步显示
- 正常模式下显示当前绿灯方向剩余秒数，对向红灯方向显示 0
- 当计数为 0 时自动熄灭对应位，避免显示 “00”

### 3. 交通灯时序（正常模式）
- 南北绿灯：30 秒
- 南北黄灯：3 秒
- 东西绿灯：30 秒
- 东西黄灯：3 秒
- 完整周期：66 秒

## 硬件连接（Proteus 仿真原理图对应）

### 主控
- STM32F103R6（或兼容的 STM32F103C8T6 等）

### 交通灯（红绿黄）
- 南北红 → PA4  
- 南北绿 → PA5  
- 南北黄 → PA6  
- 东西红 → PA7  
- 东西绿 → PA8  
- 东西黄 → PA9  

（注：灯亮为低电平，代码中已通过宏反转）

### 四位共阳数码管
- 段选 a~g、dp → PB0~PB7
- 位选 DIG1~DIG4 → PB8~PB11
  - DIG1、DIG2：东西向倒计时（左两位）
  - DIG3、DIG4：南北向倒计时（右两位）

### 模式切换按键（带上拉）
- KEY1 → PC0
- KEY2 → PC1
- KEY3 → PC2
- KEY4 → PC3

### 晶振
- 外部 8 MHz 晶振（Proteus 仿真使用 8 MHz，避免高频卡顿）

## 软件架构
STM32F103
├── Start               // 启动文件
├── System              // 系统核心文件（如 core_cm3.c、system_stm32f10x.c 等）
├── User                // 主程序及配置
│   ├── main.c
│   └── config.h
├── Inc                 // 所有头文件目录
├── Drivers/GPIO        // GPIO 驱动
│   ├── gpio.c
│   └── gpio.h
├── Drivers/Timer       // 定时器驱动
│   ├── tim2.c
│   └── tim2.h
├── System/Delay        // 延时函数
│   ├── Delay.c
│   └── Delay.h
├── BSP/LED             // 交通灯 LED 驱动
│   ├── trafficLed.c
│   └── trafficLed.h
├── BSP/Segment         // 数码管驱动
│   ├── seg.c
│   └── seg.h
├── BSP/Key             // 按键驱动
│   ├── key.c
│   └── key.h
└── App/App_Traffic     // 应用层交通灯逻辑
├── app_Traffic.c
└── app_Traffic.h

### 关键设计说明

1. **时间基准**
   - 使用 TIM2 配置为 1ms 中断（72MHz 系统时钟，PSC=72-1，ARR=1000-1）
   - Proteus 仿真使用 8MHz 外部晶振，导致实际时间变慢，因此在 `config.h` 中将 1 秒定义为 100 次 Tick（约实际 1 秒）

2. **数码管显示**
   - 动态扫描，每位显示约 2ms
   - 主循环中不断调用 `Segment_Display_Number(ewTimer, snTimer)` 实现刷新

3. **按键处理**
   - 20ms 周期扫描 + 状态机消抖
   - 仅在按下瞬间返回键值，避免长按重复触发

4. **模式切换逻辑**
   - 按键优先级：任一时刻只识别最新按下的有效键
   - 从非正常模式切换回正常模式时，会自动恢复到“南北绿灯 30s”状态，避免状态错乱

## 编译环境建议

- Keil uVision5（MDK-ARM）
- STM32F10x 标准外设库（本项目仅使用了头文件 `stm32f10x.h`，实际操作全为寄存器）
- 目标芯片选择 STM32F103R6 或兼容型号

## Proteus 仿真注意事项

1. 晶振设置为 **8 MHz**（与代码中 TIM2 分频匹配）
2. STM32 型号选择支持 64 引脚的（如 STM32F103R6/R8 等）
3. 数码管使用共阳极型号，段选低电平点亮
4. 按键连接上拉电阻，按下接 GND
5. 交通灯 LED 阳极接 VCC，阴极接 STM32 IO（低电平亮）

## 扩展建议

- 增加行人过街按钮及红绿灯
- 加入传感器自适应调整绿灯时间
- 添加闪烁红灯提示功能
- 移植到 HAL 库提升可读性
- 增加 LCD/OLED 显示当前模式文字

## 结语

本项目完整实现了从底层驱动到应用逻辑的嵌入式开发流程，代码模块化程度高、注释完整，非常适合作为 STM32 寄存器编程的教学或实训参考案例。

如有问题，欢迎交流！

**—— JaRyon 2025**